<!-- # Homepage and Dashboard -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Messier Tracker</title>

    <!-- front end tools: bootstrap, charts, particles, highcharts, icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Nebulous progress fill (not a highchart - to be deprecated) */
        #progress-bar {
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 5px #fff;
            background: linear-gradient(270deg, #8b5fbf, #6e4aa5, #4a6ea5, #bf5f9e);
            background-size: 600% 600%;
            animation: nebula 8s ease infinite;
            position: relative;
            overflow: hidden;
        }

        /* Nebula gradient animation - may delete */
        @keyframes nebula {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .progress {
            border: 2px solid #8b5fbf;
            border-radius: 5px;
            background-color: #2f2f2f;
        }

        @keyframes galaxyGlow {
          0%   {filter: drop-shadow(0 0 0 rgba(191, 95, 158, 0.0)); }
          50%  {filter: drop-shadow(0 0 10px rgba(191, 95, 158, 0.9)); }
          100% {filter: drop-shadow(0 0 0 rgba(191, 95, 158, 0.0));}
        }
        .hc-glow{
          animation: galaxyGlow 2.5s ease-in-out infinite;
        }

    </style>
</head>

<body style="background-color: #110; color: #8b537f; font-family:Verdana, Geneva, Tahoma, sans-serif;">

    <!-- Starfield background -->
    <div id="particles-js" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;">
    </div>

    <!-- Page Content -->
    <div style="position: relative; z-index: 1;" class="container mt-4">

        <!-- Page title -->
        <div class="text-center", style="font-family:fantasy; color:#84ccfc; font-size:30px; font-weight:bold; padding-bottom: 20px;">
            <h1>{{ (user.user_name or user.username or user.name)|default('Astronomer', true) }}'s Messier Tracker</h1>
        </div>

        <h4 class="text-center", style="color:#cbb0d6; font-size:20px; font-weight:bold;" >Total Messier Progress</h4> 

        <!-- Highcharts progress bar-->
        <div id="hc-total-progress" style="height: 46px; margin: 12px 0;"></div>

        <!-- Highcharts Donuts -->
        <div class="row g-3 mt-2">
        <div class="col-12 col-md-4">
            <div id="donut-galaxies" style="height:220px;"></div>
        </div>
        <div class="col-12 col-md-4">
            <div id="donut-nebulae" style="height:220px;"></div>
        </div>
        <div class="col-12 col-md-4">
            <div id="donut-clusters" style="height:220px;"></div>
        </div>
        </div>


        <!-- Journal section -->
        <div class="card mt-4" style="background-color:#1a1a1a; border:2px solid #8b537f;">
            <div class="card-header position-relative d-flex justify-content-center align-items-center"
                 style="background-color:#1a1a1a; border-bottom:2px solid #8b537f;">
                <h4 class="m-0 w-100 text-center", style="color:#8b537f;">
                    {{ (user.user_name or user.username or user.name)|default('Astronomer', true) }}'s Journal 
                </h4> 
                <!-- Plus button opens modal (backend functionality and validation in progress) -->
                <button type="button"
                        class="btn btn-sm btn-outline-light position-absolute end-0 top-50 translate-middle-y"
                        title="Add new entry"
                        data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>

            <!-- Placeholder body - populate with entries later -->
            <div class="card-body p-3" id="journal-list" style="color:#8b537f;">
                <em>No entries yet. Click the <i class="bi bi-plus-lg"></i> to add your first.</em>
            </div>
        </div>

    </div> <!-- closes page content -->

    <!-- Upload modal (placeholder for now) *************************************** journal entry pop-up ************************************* -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color:#1a1a1a; color:#8b537f; border:2px solid #8b537f;">
          <div class="modal-header">
            <h5 class="modal-title">Messier Object Entry</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form method="POST" action="{{ url_for('journal_new') }}" enctype="multipart/form-data">
              <div class="mb-3">
                <!-- select M# -->
                <label class="form-label">Messier Object</label>
                <select class="form-select" name="messier_id" required>
                  {% for m in objects %}
                    <option value="{{ m.id }}">{{ m.m_number }} â€” {{ m.common_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <!-- get date -->
              <div class="mb-3">
                <label class="form-label">Observation Date</label>
                <input type="date" class="form-control" name="observed_date" required>
              </div>
              <!-- get image -->
              <div class="mb-3">
                <label class="form-label">Image (.jpg/.jpeg/.png/.webp)</label>
                <input class="form-control" type="file" name="image" accept=".jpg,.jpeg,.png,.webp" required>
              </div>
              <!-- user notes -->
              <div class="mb-3">
                <label class="form-label">Notes (equipment, events, etc.)</label>
                <textarea class="form-control" name="journal_text" rows="4" placeholder="200mm refractor, Canon EOS R, 45s exp, clear skies, half-moon"></textarea>
              </div>

              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
          <!-- may add something herein the footer later...   -->
          <!-- <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div> -->
        </div>
      </div>
    </div>

    <!-- particles.js config -->
    <script>
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 50 },
                "size": { "value": 2 },
                "color": { "value": "#ffffff" },
                "opacity": { "value": 0.8 },
                "move": { "speed": 0.2 }
            }
        });
    </script>

    <!-- Bootstrap JS (needed for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highcharts PROGRESS BAR  -->
    <script>
  document.addEventListener('DOMContentLoaded', function () {
    // var collected = {{ user.progress.total|int }};
    var collected = 60;  //testing ******************************** update to user actual LATER ***************************************************
    var catalog = 110;
    var remaining = Math.max(catalog - collected, 0);
    var pct = Math.round((collected / catalog) * 1000) / 10;

    Highcharts.chart('hc-total-progress', { //********************************************************************************************** PROGRESS BAR
      chart: {  type: 'bar', 
                backgroundColor: 'transparent', 
                height: 46, 
                spacing: [0, 0, 0, 0] },
      // events: {
      //   load: function () {
      //     var completed = this.series[0] && this.series[0].points[0];
      //     if (completed && completed.graphic) {
      //       completed.graphic.addClass('hc-glow');
      //     }
      //   }
      // },
      title: { text: null },
      xAxis: { categories: ['Progress'], visible: false },
      yAxis: { min: 0, max: catalog, title: { text: null }, gridLineWidth: 0, labels: { enabled: false } },
      legend: { enabled: false },
      tooltip: {enabled: false},
      plotOptions: {
        series: {
          stacking: 'normal',
          borderWidth: 0,
          pointPadding: 0,
          groupPadding: 0,
        }
      },
      series: [ // can reorder series via the order listed here, but should only be completed and remaining --- REMINDER for DONUT CHARTS
        {
          name: 'Remaining',
          color: 'rgba(139,95,191,0.15)',     // muted track color
          enableMouseTracking: false,
          data: [{ y: remaining }],
          dataLabels: {
            // if nothing collected yet, show the label centered on the track, this way its easier to read
            enabled: collected === 0,
            inside: true,
            // formatter: function () { return collected + ' / ' + catalog + ' (' + pct + '%)'; },
            style: { textOutline: 'none', fontWeight: 'bold', color: '#cbb0d6' }
          }
        },
        {
          name: 'Completed',
          color: '#8b5fbf',
          data: [{ y: collected, className: 'hc-glow' }],
          dataLabels: {
            enabled: collected > 0,           // show label on the filled part
            inside: true,
            formatter: function () { return collected + ' / ' + catalog + ' (' + pct + '%)'; },
            style: { textOutline: 'none', fontWeight: 'bold', color: '#cbb0d6', fontSize: '16px' }
          }
        }
      ],
      credits: { enabled: false }
    });
  });
</script>

    <!-- Highcharts DONUT CHARTS-->
    <script>
(function () {
  // User progress (with safe fallbacks)
  var galaxiesDone = {{ (user.progress.galaxies|default(0,true))|int }};
  var nebulaeDone  = {{ (user.progress.nebulae|default(user.progress.nebulea, true)|default(0,true))|int }};
  var clustersDone = {{ (user.progress.star_clusters|default(0,true))|int }};

  // Hard-coded catalog totals for baseline (these are not changing so this is viable)
  var totalGalaxies = 40;
  var totalNebulae  = 14;
  var totalClusters = 56;

  function donut(container, completed, total, label) {  //********************************************************************************************** DONUT CHARTS
    // clamp just in case
    completed = Math.max(0, Math.min(completed, total));
    var remaining = Math.max(total - completed, 0);
    //var pct = total ? Math.round(completed / total * 1000) / 10 : 0;

    Highcharts.chart(container, {
      chart: { 
        type: 'pie', 
        backgroundColor: 'transparent',
        events: {
          render: function () {
            const chart = this;
            const width = chart.plotWidth;
            const height = chart.plotHeight;
            const centerX = chart.plotLeft + width / 2;
            const centerY = chart.plotTop + height / 2;

            //  remove the second KPI that overlaps (only seen when window is resized)
            if (chart.customCenterLabel) {
              chart.customCenterLabel.destroy();
            }
            
            // Add KPI text in the donut center
            chart.customCenterLabel = chart.renderer.text(
              completed + ' / ' + total,  
              centerX,
              centerY
            )
            .attr({
              align: 'center'
            })
            .css({
              color: '#cbb0d6',
              fontSize: '16px',
              fontWeight: 'bold'
            })
            .add();
          }
        }
      },
      title: { 
        text: label, 
        align: 'center', 
        style: { color: '#cbb0d6', fontSize: '20px' }, 
        y: 12 
      },
      tooltip: { enabled: false },
      legend: { enabled: false },
      credits: { enabled: false },
      plotOptions: {
        pie: {
          innerSize: '75%',
          borderWidth: 0,
          dataLabels: { enabled: false }, // omit lables, have above KPI
          states: { inactive: { opacity: 1 } }
        }
      },
      series: [{
        data: [
          { name: 'Completed', y: completed, color: '#8b5fbf' },
          { name: 'Remaining', y: remaining, color: 'rgba(139,95,191,0.15)' }
        ]
      }]
    });

  }

 
// TESTING
  donut('donut-galaxies', 5, totalGalaxies, 'Galaxies');
  donut('donut-nebulae',  10,  totalNebulae,  'Nebulae');
  donut('donut-clusters', 5, totalClusters, 'Star Clusters');

})();
</script>


</body>
</html>
