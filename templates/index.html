<!-- # Homepage and Dashboard -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Messier Tracker</title>

    <!-- front end tools: bootstrap, charts, particles, highcharts, icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Nebulous progress fill (not a highchart - to be deprecated) */
        #progress-bar {
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 5px #fff;
            background: linear-gradient(270deg, #8b5fbf, #27816e, #4a6ea5, #bf5f9e);
            background-size: 600% 600%;
            animation: nebula 5s ease infinite;
            position: relative;
            overflow: hidden;
        }

        /* Nebula gradient animation - may delete */
        @keyframes nebula {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .progress {
            border: 2px solid #8b5fbf;
            border-radius: 5px;
            background-color: #2f2f2f;
        }

        @keyframes galaxyGlow {
          0%   {filter: drop-shadow(0 0 0 rgba(191, 95, 158, 0.0)); }
          50%  {filter: drop-shadow(0 0 10px rgba(191, 95, 158, 0.9)); }
          100% {filter: drop-shadow(0 0 0 rgba(191, 95, 158, 0.0));}
        }

        .hc-glow{
          animation: galaxyGlow 5s ease-in-out infinite;
        }

        /* custom for add button */
        .add-btn {
        right: 8px;                 
        border-color: #00ff6600 !important;
        color: #f7a2f1 !important;
        }
        .add-btn:hover {
          background: #55395c !important; /* subtle glow on hover */
        }
        
        .journal-date {
          color: #9b78a3; /* teal-blue */
          font-style: italic;
        }
    </style>
</head>

<!-- spacey -->
<!-- IDEA? "background: radial-gradient(circle at center, #3e0f53, #0e0418 75%);  -->
<!-- <head>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="background:#161518; 
             color:#8b537f; 
             font-family:'Orbitron', sans-serif;"> -->

<!-- more modern = Exo 2 "https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" -->
<head>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap" rel="stylesheet">
</head>
<!-- change page background -->
<body style="background:#1d1b24; 
             color:#9e6399; 
             font-family:'Rajdhani', sans-serif; font-size: 20px;">

    <!-- Starfield background -->
    <div id="particles-js" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;">
    </div>

    <!-- Page Content -->
    <div style="position: relative; z-index: 1;" class="container mt-4">

        <!-- Header with Image-->
        <header class="text-center my-3">
          <!-- hidden -->
          <h1 class="visually-hidden">
            {{ (user.user_name or user.username or user.name)|default('Astronomer', true) }}'s Messier Tracker
          </h1>

          <!-- alt here handles in case the image cannot be read for whatever reason and will at least
               show [username]'s Messier Tracker' -->
          <img
            src="{{ url_for('static', filename='img/MyMessierTracker_header_v2.png') }}"
            alt="{{ (user.user_name or user.username or user.name)|default('Astronomer', true) }}'s Messier Tracker" 
            class="img-fluid"
            style="max-width: 980px; width: 60%; height: auto; filter: drop-shadow(0 0 8px rgba(123, 235, 243, 0)); 
                   padding-bottom: 50px;"
          /> <!-- testing dropshadow = TODO remove? -->

          <div class="mt-2" style="font-size:1.1rem;">
            <!-- Welcome, {{ (user.user_name or user.username or user.name)|default('Astronomer', true) }} -->
          </div>
        </header>




        <h4 class="m-0 w-100 text-center", style="color:#f4f2f5; font-weight:bold; font-size: 40px;" >Total Objects Captured </h4> 

        <!-- Highcharts progress bar-->
        <div id="hc-total-progress" style="color:#f4f2f5; height: 46px; margin: 12px 0;"></div>

        <!-- Highcharts Donuts -->
        <div class="row g-3 mt-2">
        <div class="col-12 col-md-4">
            <div id="donut-galaxies" style="height:220px;"></div>
        </div>
        <div class="col-12 col-md-4">
            <div id="donut-nebulae" style="height:220px;"></div>
        </div>
        <div class="col-12 col-md-4">
            <div id="donut-clusters" style="height:220px;"></div>
        </div>
        </div>


        <!-- Journal section -->
        <div class="card mt-4" style="background-color:#1a1a1a; border:2px solid #866acb;">
            <div class="card-header position-relative d-flex justify-content-center align-items-center"
                 style="background-color:#1a1a1a; border-bottom:2px solid #866acb;">
                <h4 class="m-0 w-100 text-center", style="color:#f4f2f5; font-weight:bold; font-size: 40px;">
                    {{ (user.user_name or user.username or user.name)|default('Astronomer', true) }}'s Journal 
                </h4> 
                
                <!-- Plus button opens modal (backend functionality and validation in progress) -->
                <button type="button"
                        class="btn btn-sm position-absolute top-50 translate-middle-y add-btn"
                        title="Add new entry"
                        data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>

            <!-- Placeholder body - populate with entries later -->
            <div class="card-body p-3" id="journal-list" style="color:#8b537f;">
              {% if entries and entries|length %}
                <div class="list-group list-group-flush">
                  {% for e in entries %}
                  <div class="list-group-item bg-transparent text-light d-flex align-items-center">
                    {% if e.img %}
                      <img src="{{ e.img }}" alt="thumb"
                          style="width:64px;height:64px;object-fit:cover;border-radius:6px;margin-right:12px;">
                    {% endif %}
                    <div class="flex-grow-1">
                      <div class="fw-semibold">M{{ e.m_number }} — {{ e.name }}</div>
                      <div class="small journal-date">{{ e.date }}</div>
                      <div class="small journal-date">{{ e.body }}</div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <em>No entries yet. Click the <i class="bi bi-plus-lg"></i> to add your first.</em>
              {% endif %}
            </div>

        </div>

    </div> <!-- closes page content -->

    <!-- Upload modal (placeholder for now) *************************************** journal entry pop-up ************************************* -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color:#1a1a1a; color:#e4b1d9; border:2px solid #8b537f;">
          <div class="modal-header">
            <h5 class="modal-title">Messier Object Entry</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form method="POST" action="{{ url_for('journal_new') }}" enctype="multipart/form-data">
              <div class="mb-3">
                <!-- REQUIRED - select M# -->
                <label class="form-label">Messier Object*</label>
                <select class="form-select" name="messier_id" required>
                  {% for m in objects %}
                    <option value="{{ m.id }}">{{ m.m_number }} — {{ m.common_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <!-- REQUIRED - get date -->
              <div class="mb-3">
                <label class="form-label">Observation Date*</label>
                <input type="date" class="form-control" name="observed_date" required>
              </div>
              <!-- REQUIRED - get image -->
              <div class="mb-3">
                <label class="form-label">Image (.jpg/.png/.webp)*</label>
                <input class="form-control" type="file" name="image" accept=".jpg,.jpeg,.png,.webp" required>
              </div>
              <!-- OPTIONAL - user notes -->
              <div class="mb-3">
                <label class="form-label">Notes (equipment, events, etc.)</label>
                <textarea class="form-control" name="journal_text" rows="4" placeholder="200mm refractor, Canon EOS R, 45s exp, clear skies, half-moon"></textarea>
              </div>

              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
          <!-- may add something herein the pop-up footer later...   -->
          <!-- <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div> -->
        </div>
      </div>
    </div>


    <!-- Bootstrap JS (needed for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highcharts PROGRESS BAR  -->
    <script>
  document.addEventListener('DOMContentLoaded', function () {
    var collected = {{ user.progress.total|int }};
    var catalog = 110;
    var remaining = Math.max(catalog - collected, 0);
    var pct = Math.round((collected / catalog) * 1000) / 10;

    Highcharts.chart('hc-total-progress', { //************ PROGRESS BAR
      chart: {  type: 'bar', 
                backgroundColor: 'transparent', 
                height: 46, 
                spacing: [0, 0, 0, 0] },

      title: { text: null },
      xAxis: { categories: ['Progress'], visible: false },
      yAxis: { min: 0, max: catalog, title: { text: null }, gridLineWidth: 0, labels: { enabled: false } },
      legend: { enabled: false },
      tooltip: {enabled: false},
      plotOptions: {
        series: {
          stacking: 'normal',
          borderWidth: 0,
          pointPadding: 0,
          groupPadding: 0,
        }
      },
      series: [ // can reorder series via the order listed here, but should only be completed and remaining --- REMINDER for DONUT CHARTS
        {
          name: 'Remaining',
          color: 'rgba(139,95,191,0.15)',     // muted track color
          enableMouseTracking: false,
          data: [{ y: remaining }],
          dataLabels: {
            // if nothing collected yet, show the label centered on the track, this way its easier to read
            enabled: collected === 0,
            inside: true,
            // formatter: function () { return collected + ' / ' + catalog + ' (' + pct + '%)'; },
            style: { textOutline: 'none', fontWeight: 'bold', color: '#cbb0d6' }
          }
        },
        {
          name: 'Completed',
          color: '#238b98', //change prog bar color
          data: [{ y: collected, className: 'hc-glow' }],
          dataLabels: {
            enabled: collected > 0,           // show label on the filled part
            inside: true,
            formatter: function () { return collected + ' / ' + catalog + ' (' + pct + '%)'; },
            style: { textOutline: 'none', fontWeight: 'bold', color: '#f2f6fa', fontSize: '16px' }
          }
        }
      ],
      credits: { enabled: false }
    });
  });
</script>

    <!-- Highcharts DONUT CHARTS-->
    <script>
(function () {
  // User progress (with safe fallbacks)
  var galaxiesDone = {{ (user.progress.galaxies|default(0,true))|int }};
  var nebulaeDone  = {{ (user.progress.nebulae|default(user.progress.nebulea, true)|default(0,true))|int }};
  var clustersDone = {{ (user.progress.star_clusters|default(0,true))|int }};

  // Hard-coded catalog totals for baseline (these are not changing so this is viable)
  var totalGalaxies = 40;
  var totalNebulae  = 14;
  var totalClusters = 56;

  function donut(container, completed, total, label) {  //************************************************************** DONUT CHARTS
    completed = Math.max(0, Math.min(completed, total));
    var remaining = Math.max(total - completed, 0);

    Highcharts.chart(container, {
      chart: { 
        type: 'pie', 
        backgroundColor: 'transparent',
        spacing: [-10, -10, -10, 0],
        events: {
          render: function () {
            const chart = this;
            const width = chart.plotWidth;
            const height = chart.plotHeight;
            const centerX = chart.plotLeft + width / 2;
            const centerY = chart.plotTop + height / 2;

            //  remove the second KPI that overlaps (only seen when window is resized)
            if (chart.customCenterLabel) {
              chart.customCenterLabel.destroy();
            }
            
            // Add KPI text in the donut center
            chart.customCenterLabel = chart.renderer.text(
              completed + ' / ' + total,  
              centerX,
              centerY
            )
            .attr({
              align: 'center'
            })
            .css({
              color: '#f4f2f5', //text color
              fontSize: '16px',
              fontWeight: 'bold'
            })
            .add();
          }
        }
      },
      title: {  // highchart donut titles
        text: label, 
        align: 'center', 
        style: { color: '#f4f2f5', fontSize: '20px' }, 
        y: 30 
      },
      tooltip: { enabled: false },
      legend: { enabled: false },
      credits: { enabled: false },
      plotOptions: {
        pie: {
          // size: '100%',
          innerSize: '70%',
          borderWidth: 0,
          dataLabels: { enabled: false }, // omit lables, have above KPI
          states: { inactive: { opacity: 1 } }
        }
      },
      series: [{
        data: [
          { name: 'Completed', y: completed, color: '#2db1c1' },
          { name: 'Remaining', y: remaining, color: 'rgba(139,95,191,0.15)' }
        ]
      }]
    });

  }

 
// TESTING
  donut('donut-galaxies', galaxiesDone, totalGalaxies, 'Galaxies');
  donut('donut-nebulae',  nebulaeDone,  totalNebulae,  'Nebulae');
  donut('donut-clusters', clustersDone, totalClusters, 'Star Clusters');

})();
</script>


</body>
</html>
